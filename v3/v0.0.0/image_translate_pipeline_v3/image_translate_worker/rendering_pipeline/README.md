# 렌더링 파이프라인 (Rendering Pipeline)

이 파이프라인은 인페인팅이 완료된 이미지에 번역된 텍스트를 렌더링하고, 최종 결과물을 생성하는 역할을 담당합니다. 처리 과정은 이미지의 품질과 자연스러움을 극대화하기 위해 여러 단계로 구성됩니다.

## 주요 처리 과정

`RenderingProcessor.process_rendering_sync` 함수를 통해 다음 단계들이 순차적으로 실행됩니다.

### 1. 최종 출력 크기 결정
- **역할**: 원본 이미지의 크기와 비율에 따라 최종 결과물의 해상도를 결정합니다.
- **세부 동작**:
    - 일반적인 이미지(`is_long=false`)는 설정된 목표 크기(예: 1024x1024)로 리사이즈됩니다.
    - 세로로 긴 웹툰 같은 이미지(`is_long=true`)는 가로폭을 고정(예: 864px)하고, 원본 비율에 맞춰 세로 길이를 계산하여 이미지 왜곡을 방지합니다.

### 2. 이미지 리사이즈
- **역할**: 원본 이미지와 인페인팅된 이미지를 1단계에서 결정된 최종 크기로 조정합니다.
- **세부 동작**: `cv2.INTER_AREA` 보간법을 사용하여 이미지 품질 손실을 최소화하며 리사이즈를 수행합니다.

### 3. 바운딩 박스 좌표 스케일링
- **역할**: 이미지 크기가 변경됨에 따라, 텍스트가 위치할 바운딩 박스의 좌표 또한 새로운 해상도에 맞게 재계산합니다.

### 4. 로컬 색상 보정 (`_correct_global_color`)
- **역할**: 인페인팅 과정에서 발생할 수 있는 미세한 색상 왜곡을 보정하여, 텍스트가 지워진 영역이 주변 배경과 완벽하게 어우러지도록 만듭니다. 이 단계는 결과물의 완성도를 결정하는 핵심적인 과정입니다.
- **동작 원리**:
    1.  **(전처리) '오염 지도' 생성**:
        - 이미지에 있는 **모든** 텍스트 박스 좌표를 기반으로 '오염 지도'를 생성합니다. 이 지도는 다른 텍스트 박스의 영향으로부터 샘플링을 보호하는 역할을 합니다. (상세 내용은 하단 `MASK_PADDING_PIXELS의 역할` 참조)
    2.  **개별 박스 순회 및 '깨끗한 샘플링 링' 확보**:
        - 각 텍스트 박스를 순회하며, 해당 박스로부터 특정 거리만큼 떨어진 곳에 '링(Ring)' 모양의 샘플링 후보 영역을 설정합니다.
        - 이 후보 영역에서 위에서 만든 '오염 지도'를 제외하여, 어떤 인페인팅 영역과도 겹치지 않는 **'깨끗한 샘플링 링'**을 최종적으로 확보합니다.
        - 만약 확보된 영역이 너무 작으면(텍스트 박스들이 밀집한 경우), 해당 박스는 색상 보정을 건너뛰어 잘못된 보정을 방지합니다.
    3.  **색상 왜곡량 계산**:
        - L\*a\*b\* 색 공간에서, '깨끗한 샘플링 링' 영역을 **원본 이미지**와 **인페인팅된 이미지**에서 각각 추출합니다.
        - 두 영역은 원래 색이 같아야 하므로, 두 영역의 색상 통계(평균, 표준편차) 차이를 비교하여 인페인팅 모델이 유발한 '색상 왜곡량'을 정확히 계산합니다.
    4.  **보정 적용**:
        - 계산된 '색상 왜곡량'을 역으로 적용하여, 현재 처리 중인 텍스트 박스의 인페인팅된 영역 색상을 원본처럼 되돌립니다.

### 5. 고품질 배경 생성
- **역할**: 선명한 원본의 장점과 색상이 보정된 인페인팅 영역의 장점을 결합하여 최상의 배경 이미지를 만듭니다.
- **세부 동작**:
    - 리사이즈된 **선명한 원본 이미지**를 베이스로 사용합니다.
    - 이 베이스 이미지 위에, 4단계에서 색상 보정이 완료된 **인페인팅 영역**만을 정확히 덮어씌웁니다(Patch).
    - 결과적으로, 텍스트가 있던 부분만 깨끗하게 지워지고 나머지 영역은 원본의 선명함을 그대로 유지하는 고품질 배경이 완성됩니다.

### 6. 텍스트 렌더링
- **역할**: 최종 배경 위에 번역된 텍스트를 자연스럽게 그려 넣습니다.
- **세부 모듈**:
    - **`TextSizeCalculator`**: 바운딩 박스 크기에 맞춰 텍스트가 넘치지 않도록 최적의 폰트 크기를 계산합니다.
    - **`TextColorSelector`**: 텍스트가 놓일 배경의 색상을 분석하여 가장 좋은 대비를 가지는 텍스트 색상을 자동으로 선택합니다.
    - **`_draw_texts_on_image`**: PIL 라이브러리를 사용하여 회전된 텍스트를 포함, 다중 라인 텍스트를 정확한 위치에 렌더링합니다.

### 7. 최종 결과물 업로드 및 전송
- **역할**: 완성된 이미지를 클라우드 스토리지에 업로드하고, 결과물의 URL을 성공 큐로 전송합니다.
- **세부 동작**:
    - 최종 이미지를 추적하기 쉽도록 파일명을 규칙에 맞게 생성하여 R2 스토리지에 업로드합니다.
    - 업로드 성공 시, 해당 URL을 Redis 성공 큐에 전송하여 다음 프로세스에 전달합니다.
    - 만약 파이프라인 과정 중 어느 단계에서든 에러가 발생하면, 에러 큐로 상세 내용을 전송하여 문제를 추적할 수 있도록 합니다.

## 핵심 파라미터: MASK_PADDING_PIXELS의 역할

`MASK_PADDING_PIXELS`는 렌더링 파이프라인의 여러 단계에서 사용되는 핵심 파라미터로, 인페인팅 영역과 주변부의 상호작용을 정교하게 제어하는 역할을 합니다. 이 값 하나를 기준으로 다양한 여백(Padding)과 간격(Offset)이 파생되어 계산됩니다.

### **1. 최종 배경 합성 영역 정의 (`+1px`)**
- **함수**: `process_rendering_sync`
- **목적**: 고품질 배경을 생성할 때, 원본 이미지 위에 덮어쓸 인페인팅 영역의 크기를 결정합니다.
- **설명**: 텍스트 박스의 실제 폴리곤(`item["box"]`)을 기준으로 `MASK_PADDING_PIXELS + 1` 만큼 확장된 영역에만 색상 보정이 완료된 인페인팅 패치를 정교하게 붙여넣습니다. 이를 통해 불필요한 영역이 합성되는 것을 방지합니다.

### **2. 색상 보정 적용 영역 정의 (`+1px`)**
- **함수**: `_get_clean_sampling_mask` (내부적으로 `_correct_global_color`에서 호출)
- **목적**: 개별 텍스트 박스 폴리곤의 색상을 보정할 범위를 지정합니다.
- **설명**: `MASK_PADDING_PIXELS + 1` 만큼 텍스트 박스 폴리곤을 확장하여, 이 영역 내부의 인페인팅된 픽셀에 대해 색상 보정 계산을 적용합니다. 이 영역은 **최종 배경 합성 영역과 정확히 일치**하여 논리적 일관성을 유지합니다.

### **3. '오염 지도' 생성 (`+3px`)**
- **함수**: `_correct_global_color`
- **목적**: 색상 샘플링 시 다른 인페인팅 영역을 침범하지 않도록 '샘플링 금지 구역'을 설정합니다.
- **설명**: 이미지에 있는 **모든** 텍스트 박스 폴리곤을 `MASK_PADDING_PIXELS + 3` 만큼 크게 확장하여 하나의 '오염 지도' 마스크를 생성합니다. 이 마스크는 특정 박스의 색상을 보정하기 위해 주변을 샘플링할 때, 다른 박스의 영향권(오염 지역)을 피하는 역할을 합니다.

### **4. '깨끗한' 색상 샘플링 위치 선정 (`+4px`)**
- **함수**: `_get_clean_sampling_mask`
- **목적**: 색상 왜곡량을 계산하기 위해, 원본과 인페인팅 이미지에서 참조할 '깨끗한' 픽셀 영역을 결정합니다.
- **설명**: 인페인팅 경계면의 불안정한 색상을 피하고자, 텍스트 박스 폴리곤으로부터 `MASK_PADDING_PIXELS + 4` 만큼 떨어진 위치에서부터 샘플링 링(Ring)을 시작합니다. 이로써 안정적이고 신뢰도 높은 색상 정보를 얻을 수 있습니다.
